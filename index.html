<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Semcas - Almoxarifado e Manutenção</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-active { border-color: #0284c7; color: #0284c7; background-color: #e0f2fe; }
        .view { display: none; }
        .view-active { display: block; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        thead th { position: sticky; top: 0; background-color: #f8fafc; z-index: 10; }
        .btn-refresh { transition: transform 0.2s ease-in-out; }
        .btn-refresh:hover { transform: rotate(45deg); }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        
        <header class="mb-6">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div class="flex items-center">
                    <img src="https://www.saoluis.ma.gov.br/img/logo_mobile.png?1738946184" alt="Logotipo da Prefeitura de São Luís" class="h-14 sm:h-16 w-auto mr-4">
                    <div>
                        <h1 class="text-2xl sm:text-3xl font-bold text-sky-700">Semcas - Almoxarifado e Manutenção</h1>
                        <p class="mt-1 text-slate-500">Painel de Controle de Estoque</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div id="last-updated" class="text-sm text-slate-500 text-right"></div>
                    <button id="refresh-button" class="btn-refresh p-2 bg-sky-600 text-white rounded-full shadow-md hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-opacity-50" title="Atualizar Dados">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7V9a1 1 0 01-2 0V3a1 1 0 011-1zm-1 5.899A7.002 7.002 0 0114.901 4.5a1 1 0 111.885-.666A9.002 9.002 0 002.05 7.5a1 1 0 011.95-.401z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
            </div>
        </header>

        <nav class="flex flex-wrap border-b border-slate-300 justify-center sm:justify-start mb-4">
            <button data-tab="estoque" class="tab flex items-center gap-2 py-3 px-4 font-semibold text-slate-600 border-b-2 border-transparent">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
                Estoque Geral
            </button>
            <button data-tab="minimo" class="tab flex items-center gap-2 py-3 px-4 font-semibold text-slate-600 border-b-2 border-transparent">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" /></svg>
                Sugestão de Compras
            </button>
            <button data-tab="validade" class="tab flex items-center gap-2 py-3 px-4 font-semibold text-slate-600 border-b-2 border-transparent">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                Controle de Validade
            </button>
            <button data-tab="relatorios" class="tab flex items-center gap-2 py-3 px-4 font-semibold text-slate-600 border-b-2 border-transparent">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                Relatório Mensal
            </button>
            <button data-tab="envios" class="tab flex items-center gap-2 py-3 px-4 font-semibold text-slate-600 border-b-2 border-transparent">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10l2-2h8a1 1 0 001-1z" /><path stroke-linecap="round" stroke-linejoin="round" d="M17 8h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1v1a1 1 0 001 1h1m-6-1v1a1 1 0 001 1h1" /></svg>
                Envios por Unidade
            </button>
        </nav>

        <main id="content-area" class="bg-white rounded-lg shadow-lg p-6 min-h-[60vh]">
            <div id="loader" class="flex justify-center items-center h-64">
                <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-sky-500"></div>
            </div>
            <div id="error-message" class="hidden text-center text-red-600 bg-red-100 p-4 rounded-lg"></div>
            <div id="estoque-view" class="view"></div>
            <div id="minimo-view" class="view"></div>
            <div id="validade-view" class="view"></div>
            <div id="relatorios-view" class="view"></div>
            <div id="envios-view" class="view"></div>
        </main>
    </div>

    <script type="module">
        const SPREADSHEET_ID = '2PACX-1vSq5-5mNONPvPSFwcvqXl3u5ClieB-tTk6WDCe0Rtzk87zgFMb6YaaMe2s3m0eTYXKa1mp_Gyo8w7er';
        const ESTOQUE_GID = '0';
        const ENVIO_GID = '812966811';
        const EXPIRATION_THRESHOLD_DAYS = 30;
        const UNIT_TYPES = ['CRAS', 'CREAS', 'ABRIGO', 'CT', 'SEDE'];

        const now = new Date();
        let state = {
            activeTab: 'estoque',
            inventoryData: [],
            sentItemsData: [],
            consumptionData: new Map(),
            categories: [],
            uniqueUnits: [],
            filters: {
                searchTerm: '',
                category: 'all',
                unitSearchTerm: '',
                forecastMonths: 3, 
                reportMonth: now.getMonth() + 1,
                reportYear: now.getFullYear(),
                reportUnitType: 'all',
                reportSpecificUnit: 'all'
            },
        };
        
        let reportChart = null;

        const dom = {
            loader: document.getElementById('loader'),
            errorMessage: document.getElementById('error-message'),
            tabs: document.querySelectorAll('.tab'),
            lastUpdated: document.getElementById('last-updated'),
            refreshButton: document.getElementById('refresh-button'),
        };

        const parseCurrency = (value) => {
            if (typeof value !== 'string') return 0;
            return parseFloat(value.replace('R$', '').replace(/\./g, '').replace(',', '.').trim()) || 0;
        };

        const parseCSV = (csvText) => {
            if (!csvText) return [];
            const lines = csvText.trim().split(/\r?\n/);
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue;
                const values = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.trim().replace(/^"|"$/g, ''));
                if (values.length >= headers.length) {
                    let row = {};
                    headers.forEach((header, index) => {
                        row[header.trim()] = values[index] || '';
                    });
                    row['Quantidade'] = parseInt(row['Quantidade'], 10) || 0;
                    row['Valor Unitário'] = parseCurrency(row['Valor Unitário']);
                    data.push(row);
                }
            }
            return data;
        };

        const formatDate = (dateString) => {
            if (!dateString || !/^\d{2}\/\d{2}\/\d{4}$/.test(dateString)) return null;
            const [day, month, year] = dateString.split('/');
            return new Date(`${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`);
        };
        
        const getUnitType = (unitName) => {
            if (!unitName) return 'Outros';
            const upperUnit = unitName.toUpperCase();
            return UNIT_TYPES.find(type => upperUnit.startsWith(type)) || 'Outros';
        };

        const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value || 0);

        const debounce = (func, delay = 300) => {
            let timer;
            return (...args) => {
                clearTimeout(timer);
                timer = setTimeout(() => func(...args), delay);
            };
        };
        
        const render = () => {
            dom.tabs.forEach(tab => tab.classList.toggle('tab-active', tab.dataset.tab === state.activeTab));
            document.querySelectorAll('.view').forEach(view => view.classList.toggle('view-active', view.id.startsWith(state.activeTab)));

            switch (state.activeTab) {
                case 'estoque': renderInventoryView(); break;
                case 'minimo': renderMinStockView(); break;
                case 'validade': renderExpirationView(); break;
                case 'relatorios': renderReportsView(); break;
                case 'envios': renderEnviosView(); break;
            }
        };

        const getFilteredData = (dataSource = state.inventoryData) => {
            return dataSource.filter(item => {
                const searchTerm = state.filters.searchTerm.toLowerCase();
                const category = state.filters.category;
                const matchesSearch = (item['Produto'] || '').toLowerCase().includes(searchTerm) || (item['Código'] || '').toLowerCase().includes(searchTerm);
                const matchesCategory = category === 'all' || (item['Categoria'] || '') === category;
                return matchesSearch && matchesCategory;
            });
        };

        const createTableHTML = (data, columns) => {
            if (!data || data.length === 0) return '<p class="text-center text-slate-500 py-8">Nenhum item encontrado.</p>';
            return `
                <div class="overflow-x-auto rounded-lg border border-slate-200 shadow-md">
                    <table class="w-full text-sm text-left text-slate-600">
                        <thead class="text-xs text-slate-700 uppercase bg-slate-50">
                            <tr>${columns.map(col => `<th scope="col" class="px-6 py-3">${col.header}</th>`).join('')}</tr>
                        </thead>
                        <tbody>
                            ${data.map(item => `<tr class="bg-white border-b hover:bg-slate-50 ${item.rowClass || ''}">
                                ${columns.map(col => `<td class="px-6 py-4 ${col.class || ''}">${col.render(item)}</td>`).join('')}
                            </tr>`).join('')}
                        </tbody>
                    </table>
                </div>`;
        };
        
        const renderInventoryView = () => {
            const view = document.getElementById('estoque-view');
            const filteredData = getFilteredData();
            const columns = [
                { header: 'Fundo', render: item => item['Fundo'] || 'N/A' },
                { header: 'Código', render: item => item['Código'] || 'N/A' },
                { header: 'Produto', render: item => item['Produto'] || 'N/A', class: 'font-semibold' },
                { header: 'Categoria', render: item => item['Categoria'] || 'N/A' },
                { header: 'Qtd. Atual', render: item => item.Quantidade, class: 'text-center font-bold' },
                { header: 'Valor Unitário', render: item => formatCurrency(item['Valor Unitário']) },
                { header: 'Valor Total', render: item => formatCurrency(item.Quantidade * item['Valor Unitário']) },
            ];
             view.innerHTML = `
                <div class="flex flex-col sm:flex-row gap-4 mb-6">
                    <input type="text" id="search-input" placeholder="Buscar por produto ou código..." class="w-full sm:w-1/2 p-3 border rounded-lg" value="${state.filters.searchTerm}">
                    <select id="category-select" class="w-full sm:w-1/2 p-3 border rounded-lg">
                        <option value="all">Todas as Categorias</option>
                        ${state.categories.map(cat => `<option value="${cat}" ${state.filters.category === cat ? 'selected' : ''}>${cat}</option>`).join('')}
                    </select>
                </div>
            ` + createTableHTML(filteredData, columns);
            document.getElementById('search-input')?.addEventListener('input', debounce(e => { state.filters.searchTerm = e.target.value; render(); }));
            document.getElementById('category-select')?.addEventListener('change', e => { state.filters.category = e.target.value; render(); });
        };
        
        const renderMinStockView = () => {
             const view = document.getElementById('minimo-view');
             const filteredData = getFilteredData();
             const suggestions = filteredData.map(item => {
                 const key = `${item['Fundo']}-${item['Código']}`;
                 const consumption = state.consumptionData.get(key) || { avg: 0 };
                 const neededStock = Math.ceil(consumption.avg * state.filters.forecastMonths);
                 const purchaseSuggestion = Math.max(0, neededStock - item.Quantidade);
                 return { ...item, avgConsumption: consumption.avg, neededStock, purchaseSuggestion };
             }).filter(item => item.purchaseSuggestion > 0).sort((a,b) => b.purchaseSuggestion - a.purchaseSuggestion);

             const columns = [
                { header: 'Fundo', render: item => item['Fundo'] },
                { header: 'Produto', render: item => item['Produto'], class: 'font-semibold' },
                { header: 'Estoque Atual', render: item => item.Quantidade, class: 'text-center' },
                { header: 'Média Saída/Mês', render: item => item.avgConsumption.toFixed(1), class: 'text-center' },
                { header: `Necessidade (${state.filters.forecastMonths} meses)`, render: item => item.neededStock, class: 'text-center' },
                { header: 'Comprar', render: item => `<span class="bg-green-100 text-green-800 font-bold px-3 py-1 rounded-full">${item.purchaseSuggestion}</span>`, class: 'text-center' },
             ];
             view.innerHTML = `
                <div class="bg-slate-50 p-4 rounded-lg border mb-6">
                    <label for="forecast-slider" class="block font-semibold mb-2">Período para Previsão: <span class="text-sky-600 font-bold">${state.filters.forecastMonths} meses</span></label>
                    <input type="range" id="forecast-slider" min="1" max="12" value="${state.filters.forecastMonths}" class="w-full">
                </div>
            ` + createTableHTML(suggestions, columns);
             document.getElementById('forecast-slider')?.addEventListener('input', e => { state.filters.forecastMonths = parseInt(e.target.value); render(); });
        };

        const renderExpirationView = () => {
            const view = document.getElementById('validade-view');
            const today = new Date(); today.setHours(0,0,0,0);
            const data = getFilteredData().map(item => {
                const expiryDate = formatDate(item['Data de Validade']);
                if (!expiryDate) return { ...item, status: 'ok' };
                const daysToExpire = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
                let status = 'ok', rowClass = '';
                if (daysToExpire < 0) { status = 'Vencido'; rowClass = 'bg-red-50 text-red-900'; }
                else if (daysToExpire <= EXPIRATION_THRESHOLD_DAYS) { status = 'Vence em breve'; rowClass = 'bg-yellow-50 text-yellow-900'; }
                return { ...item, daysToExpire, status, rowClass };
            }).filter(item => item.status !== 'ok').sort((a,b) => a.daysToExpire - b.daysToExpire);
            const columns = [
                { header: 'Produto', render: item => item['Produto'] },
                { header: 'Validade', render: item => item['Data de Validade'] },
                { header: 'Status', render: item => item.status === 'Vencido' ? `<span class="bg-red-200 text-red-900 px-2 py-1 rounded-full text-xs">${item.status}</span>` : `<span class="bg-yellow-200 text-yellow-900 px-2 py-1 rounded-full text-xs">${item.status} (${item.daysToExpire} dias)</span>` },
                { header: 'Quantidade', render: item => item.Quantidade, class: 'text-center' }
            ];
            view.innerHTML = `<div class="p-4 mb-6 text-sm text-blue-800 rounded-lg bg-blue-50">Mostrando itens vencidos ou que vencerão nos próximos <strong>${EXPIRATION_THRESHOLD_DAYS} dias</strong>.</div>` + createTableHTML(data, columns);
        };
        
        const renderReportsView = () => {
            const view = document.getElementById('relatorios-view');
            const { reportMonth, reportYear, reportUnitType, reportSpecificUnit } = state.filters;

            const availableUnitsForType = state.uniqueUnits.filter(unit => reportUnitType === 'all' || getUnitType(unit) === reportUnitType);

            const monthlySentData = state.sentItemsData.filter(item => {
                const sentDate = formatDate(item['Data de Envio']);
                if (!sentDate) return false;

                const matchesDate = (sentDate.getMonth() + 1) === reportMonth && sentDate.getFullYear() === reportYear;
                const matchesUnitType = reportUnitType === 'all' || getUnitType(item['Unidade']) === reportUnitType;
                const matchesSpecificUnit = reportSpecificUnit === 'all' || (item['Unidade'] || 'Outros') === reportSpecificUnit;
                
                return matchesDate && matchesUnitType && matchesSpecificUnit;
            });

            const totalValue = monthlySentData.reduce((sum, item) => sum + (item['Valor Unitário'] * item.Quantidade), 0);
            const totalItems = monthlySentData.reduce((sum, item) => sum + item.Quantidade, 0);

            const months = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            
            const detailsColumns = [
                { header: 'Data Envio', render: item => item['Data de Envio'] || 'N/A' },
                { header: 'Fundo', render: item => item['Fundo'] || 'N/A' },
                { header: 'Código', render: item => item['Código'] || 'N/A' },
                { header: 'Produto', render: item => item['Produto'] || 'N/A', class: 'font-semibold' },
                { header: 'Unidade', render: item => item['Unidade'] || 'N/A' },
                { header: 'Qtd.', render: item => item.Quantidade, class: 'text-center' },
                { header: 'Valor Total', render: item => formatCurrency(item.Quantidade * (item['Valor Unitário'] || 0)), class: 'text-right' },
            ];

            view.innerHTML = `
                <div class="bg-slate-50 p-4 rounded-lg border mb-6">
                    <div class="grid grid-cols-1 sm:grid-cols-4 gap-4">
                        <select id="report-month-select" class="w-full p-2 border rounded-md">${months.map((m, i) => `<option value="${i + 1}" ${reportMonth === i + 1 ? 'selected' : ''}>${m}</option>`).join('')}</select>
                        <select id="report-year-select" class="w-full p-2 border rounded-md">${Array.from({length: 5}, (_, i) => now.getFullYear() - i).map(y => `<option value="${y}" ${reportYear === y ? 'selected' : ''}>${y}</option>`).join('')}</select>
                        <select id="report-unittype-select" class="w-full p-2 border rounded-md">
                            <option value="all">Todos os Tipos</option>
                            ${[...UNIT_TYPES, "Outros"].map(type => `<option value="${type}" ${reportUnitType === type ? 'selected' : ''}>${type}</option>`).join('')}
                        </select>
                         <select id="report-specific-unit-select" class="w-full p-2 border rounded-md">
                            <option value="all">Todas as Unidades</option>
                            ${availableUnitsForType.map(unit => `<option value="${unit}" ${reportSpecificUnit === unit ? 'selected' : ''}>${unit}</option>`).join('')}
                        </select>
                    </div>
                </div>
                ${monthlySentData.length === 0 ? '<p class="text-center text-slate-500 py-8">Nenhum envio encontrado para os filtros selecionados.</p>' : `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow border"><h3 class="text-sm text-slate-500">Valor Total Enviado</h3><p class="mt-2 text-3xl font-bold text-sky-600">${formatCurrency(totalValue)}</p></div>
                    <div class="bg-white p-6 rounded-lg shadow border"><h3 class="text-sm text-slate-500">Total de Itens Enviados</h3><p class="mt-2 text-3xl font-bold text-sky-600">${totalItems}</p></div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow border mb-8">
                    <h3 id="chart-title" class="text-lg font-semibold mb-4"></h3>
                    <canvas id="report-chart"></canvas>
                </div>
                <div class="mt-8">
                    <h3 class="text-lg font-semibold mb-4">Detalhes dos Envios no Período</h3>
                    ${createTableHTML(monthlySentData.sort((a,b) => (formatDate(b['Data de Envio']) || 0) - (formatDate(a['Data de Envio']) || 0)), detailsColumns)}
                </div>`}
            `;

            const chartCtx = document.getElementById('report-chart')?.getContext('2d');
            const chartTitle = document.getElementById('chart-title');
            if (chartCtx && chartTitle) {
                if(reportChart) reportChart.destroy();
                
                let chartConfig;
                if(reportSpecificUnit === 'all') {
                    chartTitle.textContent = reportUnitType === 'all' ? 'Valor por Tipo de Unidade' : `Comparativo de Unidades: ${reportUnitType}`;
                    const dataMap = monthlySentData.reduce((acc, item) => {
                        const key = reportUnitType === 'all' ? getUnitType(item['Unidade']) : (item['Unidade'] || 'Outros');
                        if (!acc[key]) acc[key] = 0;
                        acc[key] += (item['Valor Unitário'] || 0) * item.Quantidade;
                        return acc;
                    }, {});

                    chartConfig = {
                        type: 'bar',
                        data: { labels: Object.keys(dataMap), datasets: [{ data: Object.values(dataMap), backgroundColor: 'rgba(2, 132, 199, 0.6)' }] },
                        options: { responsive: true, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
                    };
                } else {
                    chartTitle.textContent = `Distribuição de Custos por Categoria: ${reportSpecificUnit}`;
                    const dataMap = monthlySentData.reduce((acc, item) => {
                        const key = item['Categoria'] || 'Sem Categoria';
                        if (!acc[key]) acc[key] = 0;
                        acc[key] += (item['Valor Unitário'] || 0) * item.Quantidade;
                        return acc;
                    }, {});

                    chartConfig = {
                        type: 'doughnut',
                        data: {
                            labels: Object.keys(dataMap),
                            datasets: [{ data: Object.values(dataMap), backgroundColor: ['#0284c7', '#f97316', '#16a34a', '#e11d48', '#6d28d9', '#facc15'] }]
                        },
                        options: { responsive: true, plugins: { legend: { position: 'top' } } }
                    };
                }
                reportChart = new Chart(chartCtx, chartConfig);
            }

             document.getElementById('report-month-select')?.addEventListener('change', e => { state.filters.reportMonth = parseInt(e.target.value); render(); });
             document.getElementById('report-year-select')?.addEventListener('change', e => { state.filters.reportYear = parseInt(e.target.value); render(); });
             document.getElementById('report-unittype-select')?.addEventListener('change', e => { 
                state.filters.reportUnitType = e.target.value; 
                state.filters.reportSpecificUnit = 'all';
                render(); 
             });
             document.getElementById('report-specific-unit-select')?.addEventListener('change', e => { state.filters.reportSpecificUnit = e.target.value; render(); });
        };
        
        const renderEnviosView = () => {
             const view = document.getElementById('envios-view');
             const searchTerm = state.filters.unitSearchTerm.toLowerCase();
             const filteredUnits = state.uniqueUnits.filter(unit => unit.toLowerCase().includes(searchTerm));
             
             view.innerHTML = `
                <div class="mb-6">
                    <input type="text" id="unit-search-input" value="${state.filters.unitSearchTerm}" placeholder="Buscar por unidade..." class="w-full sm:w-1/2 p-3 border rounded-lg">
                </div>
                <div class="space-y-8">
                ${(filteredUnits.length > 0 ? filteredUnits : (searchTerm ? [] : state.uniqueUnits)).map(unit => {
                    const items = state.sentItemsData.filter(item => (item['Unidade'] || 'N/A') === unit);
                    if(items.length === 0) return '';
                    const columns = [
                        { header: 'Data Envio', render: item => item['Data de Envio'] || 'N/A' },
                        { header: 'Fundo', render: item => item['Fundo'] || 'N/A' },
                        { header: 'Código', render: item => item['Código'] || 'N/A' },
                        { header: 'Produto', render: item => item['Produto'] || 'N/A', class: 'font-semibold' },
                        { header: 'Quantidade', render: item => item.Quantidade, class: 'text-center font-bold' }
                    ];
                    return `
                        <div class="bg-slate-50 rounded-lg shadow-md p-4">
                            <h3 class="font-bold text-lg text-sky-700 mb-3">${unit}</h3>
                            ${createTableHTML(items.sort((a,b) => (formatDate(b['Data de Envio']) || 0) - (formatDate(a['Data de Envio']) || 0)), columns)}
                        </div>
                    `;
                 }).join('') || '<p class="text-center text-slate-500 py-8">Nenhuma unidade encontrada.</p>'}
                </div>`;
            
             document.getElementById('unit-search-input')?.addEventListener('input', debounce(e => { state.filters.unitSearchTerm = e.target.value; render(); }));
        };

        const init = async () => {
            dom.loader.style.display = 'flex';
            dom.errorMessage.style.display = 'none';

            try {
                const fetchSheet = async (gid) => {
                    const url = `https://docs.google.com/spreadsheets/d/e/${SPREADSHEET_ID}/pub?output=csv&gid=${gid}`;
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`Falha ao carregar dados (GID: ${gid})`);
                    return response.text();
                };

                const [estoqueResult, envioResult] = await Promise.allSettled([
                    fetchSheet(ESTOQUE_GID),
                    ENVIO_GID ? fetchSheet(ENVIO_GID) : Promise.resolve('')
                ]);

                if (estoqueResult.status === 'rejected') throw estoqueResult.reason;
                const initialStock = parseCSV(estoqueResult.value);
                const sentItemsRaw = envioResult.status === 'fulfilled' ? parseCSV(envioResult.value) : [];

                const productDetailsMap = new Map();
                initialStock.forEach(item => {
                    const key = `${item['Fundo']}-${item['Código']}`;
                    productDetailsMap.set(key, item);
                });

                state.sentItemsData = sentItemsRaw.map(item => {
                    const key = `${item['Fundo']}-${item['Código']}`;
                    const details = productDetailsMap.get(key) || {};
                    const envioUnidade = item['Unidade']; 
                    const mergedItem = { ...item, ...details }; 
                    mergedItem['Unidade'] = envioUnidade;
                    return mergedItem;
                });

                const consumption = new Map();
                state.sentItemsData.forEach(item => {
                    const date = formatDate(item['Data de Envio']);
                    if (!date || !item['Fundo'] || !item['Código']) return;
                    const key = `${item['Fundo']}-${item['Código']}`;
                    const monthYear = `${date.getMonth() + 1}-${date.getFullYear()}`;
                    if (!consumption.has(key)) {
                        consumption.set(key, { total: 0, months: new Set() });
                    }
                    const record = consumption.get(key);
                    record.total += item.Quantidade;
                    record.months.add(monthYear);
                });
                consumption.forEach((value) => {
                    value.avg = value.months.size > 0 ? value.total / value.months.size : 0;
                });
                state.consumptionData = consumption;

                const sentTotals = new Map();
                state.sentItemsData.forEach(item => {
                    if (!item['Fundo'] || !item['Código']) return;
                    const key = `${item['Fundo']}-${item['Código']}`;
                    sentTotals.set(key, (sentTotals.get(key) || 0) + item.Quantidade);
                });

                state.inventoryData = initialStock.map(item => {
                    const key = `${item['Fundo']}-${item['Código']}`;
                    const sentQuantity = sentTotals.get(key) || 0;
                    return { ...item, Quantidade: item.Quantidade - sentQuantity };
                });

                state.categories = [...new Set(initialStock.map(item => item['Categoria']).filter(Boolean).map(c => c.trim()))].sort();
                state.uniqueUnits = [...new Set(state.sentItemsData.map(item => item['Unidade']).filter(Boolean))].sort();
                
                dom.loader.style.display = 'none';
                dom.lastUpdated.textContent = `Atualizado em: ${new Date().toLocaleTimeString('pt-BR')}`;
                render();

            } catch (error) {
                console.error(error);
                dom.loader.style.display = 'none';
                let userMessage = `Erro ao carregar dados: ${error.message}.`;
                if (error instanceof TypeError && error.message.includes('Failed to fetch')) {
                    userMessage = 'Erro de rede ao buscar os dados da planilha. Verifique sua conexão, ou se há algum bloqueio por antivírus/firewall. Tente atualizar a página.';
                }
                dom.errorMessage.textContent = userMessage;
                dom.errorMessage.style.display = 'block';
            }
        };

        dom.tabs.forEach(tab => tab.addEventListener('click', () => { state.activeTab = tab.dataset.tab; render(); }));
        dom.refreshButton.addEventListener('click', init);
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>

